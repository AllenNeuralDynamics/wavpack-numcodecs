name: Build WavPack Libraries

on:
  workflow_dispatch:

jobs:
  build:
    name: Build WavPack for glibc ${{ matrix.glibc_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        glibc_version: ['2.31', '2.33', '2.35', '2.36', '2.37', '2.39']
        wavpack_version: ['5.7.0']  # Stick to stable version for now

    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Create Dockerfile for glibc build
      run: |
        cat > Dockerfile.build << 'EOF'
        ARG UBUNTU_VERSION
        FROM ubuntu:${UBUNTU_VERSION}
        ARG GLIBC_VERSION
        ENV GLIBC_VERSION=${GLIBC_VERSION}

        # Install all dependencies upfront before any building
        RUN apt-get update && apt-get install -y \
            build-essential \
            wget \
            bzip2 \
            automake \
            libtool \
            gcc-multilib \
            gawk \
            bison \
            python3 \
            gettext \
            texinfo \
            pkg-config \
            file \
            patchelf \
            make \
            gcc \
            autoconf \
            && ln -s /usr/bin/python3 /usr/bin/python \
            && rm -rf /var/lib/apt/lists/*

        # Create a dedicated user for building
        RUN useradd -m builder
        USER builder
        WORKDIR /home/builder

        ARG WAVPACK_VERSION
        # Download WavPack source first
        RUN set -x \
            && echo "Downloading WavPack ${WAVPACK_VERSION}..." \
            && wget https://github.com/dbry/WavPack/releases/download/${WAVPACK_VERSION}/wavpack-${WAVPACK_VERSION}.tar.bz2 \
            && tar xjf wavpack-${WAVPACK_VERSION}.tar.bz2

        # Build glibc
        RUN set -x \
            && echo "Building glibc version ${GLIBC_VERSION}" \
            && wget https://ftp.gnu.org/gnu/glibc/glibc-${GLIBC_VERSION}.tar.bz2 \
            && echo "Extracting glibc source..." \
            && tar xjf glibc-${GLIBC_VERSION}.tar.bz2 \
            && mkdir glibc-build \
            && cd glibc-build \
            && echo "Configuring glibc..." \
            && CFLAGS="-O2 -U_FORTIFY_SOURCE" CPPFLAGS="-U_FORTIFY_SOURCE" ../glibc-${GLIBC_VERSION}/configure \
                --prefix=/home/builder/glibc-install \
                --disable-werror \
                --enable-add-ons \
                --with-headers=/usr/include \
                --without-selinux \
                --disable-stack-protector \
                --enable-kernel=3.2 \
                > ../configure.log 2>&1 || (cat ../configure.log && false) \
            && echo "Building glibc..." \
            && make -j$(nproc) > ../make.log 2>&1 || (cat ../make.log && false) \
            && echo "Installing glibc..." \
            && make install > ../install.log 2>&1 || (cat ../install.log && false) \
            && echo "glibc build completed successfully"

        # Verify glibc installation
        RUN /home/builder/glibc-install/lib/libc.so.6 --version

        ENV PATH=/home/builder/glibc-install/bin:$PATH \
            LD_LIBRARY_PATH=/home/builder/glibc-install/lib:$LD_LIBRARY_PATH \
            CFLAGS="-I/home/builder/glibc-install/include" \
            LDFLAGS="-L/home/builder/glibc-install/lib"

        # Build WavPack using the newly built glibc
        RUN cd wavpack-${WAVPACK_VERSION} \
            && echo "Running autoconf..." \
            && autoreconf -fi \
            && echo "Configuring WavPack..." \
            && ./configure --enable-shared \
                         --prefix=/home/builder/wavpack-install \
                         > ../wavpack-configure.log 2>&1 || (cat ../wavpack-configure.log && false) \
            && echo "Building WavPack..." \
            && make > ../wavpack-make.log 2>&1 || (cat ../wavpack-make.log && false) \
            && echo "Installing WavPack..." \
            && make install > ../wavpack-install.log 2>&1 || (cat ../wavpack-install.log && false)

        USER root

        # Create output directory with the built libraries
        RUN mkdir -p /output/linux-x86_64-glibc${GLIBC_VERSION} \
            && cp /home/builder/wavpack-install/lib/libwavpack.so* /output/linux-x86_64-glibc${GLIBC_VERSION}/ \
            && cp /home/builder/wavpack-install/lib/libwavpack.so /output/linux-x86_64-glibc${GLIBC_VERSION}/libwavpack.so.1 \
            && patchelf --set-rpath '$ORIGIN' /output/linux-x86_64-glibc${GLIBC_VERSION}/*.so* \
            && echo "Built libraries:" \
            && ls -l /output/linux-x86_64-glibc${GLIBC_VERSION}/ \
            && ldd /output/linux-x86_64-glibc${GLIBC_VERSION}/libwavpack.so

        # Clean up build files to reduce image size
        RUN rm -rf \
            /home/builder/glibc-* \
            /home/builder/wavpack-* \
            /var/lib/apt/lists/*
        EOF

    - name: Set Ubuntu version
      id: ubuntu-version
      run: |
        case ${{ matrix.glibc_version }} in
          2.31)
            echo "version=20.04" >> $GITHUB_OUTPUT
            ;;
          2.33|2.35)
            echo "version=22.04" >> $GITHUB_OUTPUT
            ;;
          2.36|2.37)
            echo "version=23.10" >> $GITHUB_OUTPUT
            ;;
          2.39)
            echo "version=24.04" >> $GITHUB_OUTPUT
            ;;
        esac

    - name: Build Docker image and extract libraries
      run: |
        docker build \
          --build-arg GLIBC_VERSION=${{ matrix.glibc_version }} \
          --build-arg WAVPACK_VERSION=${{ matrix.wavpack_version }} \
          --build-arg UBUNTU_VERSION=${{ steps.ubuntu-version.outputs.version }} \
          -f Dockerfile.build \
          -t wavpack-builder .
        
        mkdir -p src/wavpack_numcodecs/libraries/${{ matrix.wavpack_version }}
        docker create --name wavpack-container wavpack-builder
        docker cp wavpack-container:/output/. src/wavpack_numcodecs/libraries/${{ matrix.wavpack_version }}/
        docker rm wavpack-container

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wavpack-libs-glibc${{ matrix.glibc_version }}
        path: src/wavpack_numcodecs/libraries/${{ matrix.wavpack_version }}/linux-x86_64-glibc${{ matrix.glibc_version }}

    - name: List built files
      run: |
        ls -la src/wavpack_numcodecs/libraries/${{ matrix.wavpack_version }}/linux-x86_64-glibc${{ matrix.glibc_version }}
